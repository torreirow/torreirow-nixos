# SSH Config Hosts Module

NixOS Home Manager module for managing SSH host configurations with rbw (Bitwarden CLI) SSH keys.

## Features

- ✅ **Automatic discovery**: All `.json` files in `hosts/` directory are automatically loaded
- ✅ **Declarative**: SSH config is generated from JSON files
- ✅ **Multiple files**: Organize configurations by customer, environment, or purpose
- ✅ **rbw integration**: Uses SSH keys from Bitwarden via rbw SSH agent
- ✅ **No private keys on disk**: All keys managed through rbw agent
- ✅ **Per-file configs**: Each JSON file generates its own SSH config file
- ✅ **Self-contained**: Export script included in module
- ✅ **Agenix support**: Encrypt sensitive host configurations using agenix

## Prerequisites

This module requires:
- `rbw` - Bitwarden CLI client (should already be installed and configured)
- `jq` - JSON processor (usually pre-installed on NixOS)
- `openssh` - SSH client
- rbw SSH agent configured and running

The rbw SSH agent should be configured to use `$XDG_RUNTIME_DIR/rbw/ssh-agent-socket` as the SSH auth socket.

## Directory Structure

```
home/module/ssh-config_hosts/
├── default.nix              # Main module configuration
├── export-ssh-keys.sh       # Script to export SSH keys from rbw
├── README.md                # This file
└── hosts/                   # JSON configuration files directory
    ├── README.md            # Documentation for JSON format
    ├── ssh-hosts.json       # General/personal hosts
    ├── customer-a.json      # Customer A hosts
    └── customer-b.json      # Customer B hosts (add as many as needed)
```

## Quick Start

### 1. Enable the module in your flake.nix

Add the module to your home configuration imports:

```nix
homeConfigurations."user@host" = home-manager.lib.homeManagerConfiguration {
  modules = [
    ./home/module/ssh-config_hosts  # Add this line
    # ... other modules
  ];
};
```

### 2. Add SSH keys to Bitwarden/rbw

SSH keys must be stored in Bitwarden in the `ssh-keys` folder with:
- A unique **name** (e.g., `my-server-key`)
- A **public_key** field containing the public key
- A **fingerprint** field (auto-generated by Bitwarden SSH key type)

### 3. Create host configuration

Create a JSON file in `hosts/`:

```bash
vim home/module/ssh-config_hosts/hosts/ssh-hosts.json
```

```json
[
  {
    "host": "myserver",
    "hostname": "192.168.1.100",
    "user": "admin",
    "identity_file": "my-server-key",
    "port": 22
  }
]
```

### 4. Apply configuration

```bash
home-manager switch --flake .#user@host
```

### 5. Export SSH keys from rbw

```bash
~/bin/export-ssh-keys.sh
```

### 6. Connect

```bash
ssh myserver
```

## Usage

### Adding new hosts

Simply create or edit JSON files in `hosts/` directory:

```bash
vim home/module/ssh-config_hosts/hosts/customer-acme.json
```

Then rebuild:

```bash
home-manager switch
```

The new config file `~/.ssh/config.d/rbw-customer-acme.conf` will be automatically created!

## How it works

1. **Discovery**: The module scans `hosts/` directory for all `.json` files
2. **Parsing**: Each JSON file is parsed and validated
3. **Generation**: SSH config entries are generated for each JSON file
4. **Output**: Each JSON file generates its own config file in `~/.ssh/config.d/`
   - `ssh-hosts.json` → `~/.ssh/config.d/rbw-ssh-hosts.conf`
   - `customer-a.json` → `~/.ssh/config.d/rbw-customer-a.conf`
   - `customer-b.json` → `~/.ssh/config.d/rbw-customer-b.conf`
5. **Keys**: SSH keys are loaded from `~/.ssh/rbw-keys/` (exported from rbw)

## Generated files

- `~/.ssh/config.d/rbw-*.conf` - Generated SSH configs (one per JSON file)
- `~/.ssh/rbw-keys/*.pub` - Exported SSH public keys
- `~/bin/export-ssh-keys.sh` - Script to export keys from rbw

## JSON Configuration Format

See `hosts/README.md` for detailed JSON format documentation.

### Quick reference

```json
{
  "host": "alias",              // Required: SSH host alias or pattern
  "hostname": "actual.host",    // Optional: real hostname/IP
  "user": "username",           // Optional: SSH username
  "identity_file": "key-name",  // Required: rbw key name (without .pub)
  "port": 22                    // Optional: SSH port (default: 22)
}
```

## Using Agenix for Encrypted Host Configurations

For sensitive SSH host configurations (e.g., production servers, customer environments), you can use agenix to encrypt the JSON files.

### Setup encrypted configuration

**1. Create an encrypted JSON file:**

```bash
# Create a regular JSON file first
cat > /tmp/customer-secret.json <<EOF
[
  {
    "host": "prod-server",
    "hostname": "production.customer.com",
    "user": "admin",
    "identity_file": "production-key",
    "port": 22
  }
]
EOF

# Encrypt it with agenix
agenix -e secrets/ssh-hosts-customer-secret.json.age < /tmp/customer-secret.json
rm /tmp/customer-secret.json
```

**2. Add the secret to your NixOS configuration:**

In your `hosts/lobos/lobos-secrets.nix` (or equivalent):

```nix
age.secrets.ssh-hosts-customer-secret = {
  file = ../../secrets/ssh-hosts-customer-secret.json.age;
  path = "/run/secrets/ssh-hosts-customer-secret";
  owner = "wtoorren";
  mode = "0400";
};
```

**3. Reference the secret in your home-manager configuration:**

In your home-manager modules (e.g., `home/sshkeys.nix`):

```nix
programs.ssh-config-hosts.agenixSecrets = [
  {
    name = "customer-secret";
    path = "/run/secrets/ssh-hosts-customer-secret";  # Use the same path as in NixOS config
  }
];
```

**Important**: Use the direct path string (`"/run/secrets/..."`), not `config.age.secrets.*.path`, because agenix secrets are only available in NixOS configuration, not in home-manager.

**4. Apply configuration:**

```bash
sudo nixos-rebuild switch --flake .#lobos
home-manager switch --flake .#wtoorren@linuxdesktop
```

The encrypted configuration will generate `~/.ssh/config.d/rbw-customer-secret.conf`!

### Benefits of using agenix

- **Security**: Sensitive host information encrypted in Git
- **Version control**: Track changes to production configs safely
- **Access control**: Only authorized machines can decrypt
- **Separation**: Keep sensitive configs separate from public ones

## Common Workflows

### Adding a new customer/project

Simply create a new JSON file:

```bash
vim home/module/ssh-config_hosts/hosts/customer-newco.json
```

Add your hosts and rebuild. No need to modify the Nix configuration - it's automatically discovered!

### Temporarily disabling a customer's config

```bash
mv hosts/customer-newco.json hosts/customer-newco.json.disabled
home-manager switch
```

The `rbw-customer-newco.conf` file will be automatically removed.

### Re-enabling

```bash
mv hosts/customer-newco.json.disabled hosts/customer-newco.json
home-manager switch
```

### Adding a new SSH key to rbw

1. **In Bitwarden web interface or desktop app**:
   - Create new item of type "SSH Key"
   - Set folder to `ssh-keys`
   - Name it (e.g., `new-server-key`)
   - Add public key to `public_key` field
   - Bitwarden auto-generates the fingerprint

2. **Sync rbw**:
   ```bash
   rbw sync
   ```

3. **Export the new key**:
   ```bash
   ~/bin/export-ssh-keys.sh
   ```

4. **Add to host config**:
   ```json
   {
     "host": "newserver",
     "identity_file": "new-server-key"
   }
   ```

5. **Rebuild**:
   ```bash
   home-manager switch
   ```

## SSH Key Management

SSH keys must be:
1. Stored in rbw (Bitwarden) in the `ssh-keys` folder
2. Have a `fingerprint` field (auto-generated by Bitwarden)
3. Loaded into rbw SSH agent

The module includes and installs `export-ssh-keys.sh` as `~/bin/export-ssh-keys.sh` to export keys from rbw to `~/.ssh/rbw-keys/`.

**Note**: The script is part of this module and versioned in Git. No external dependencies needed!

## Troubleshooting

### Check generated config files

Each JSON file generates its own config:

```bash
ls -la ~/.ssh/config.d/rbw-*.conf
```

### View a specific config file

```bash
cat ~/.ssh/config.d/rbw-ssh-hosts.conf
cat ~/.ssh/config.d/rbw-customer-a.conf
```

### Verify SSH config

```bash
ssh -G hostname
```

### List available SSH keys

```bash
ssh-add -l
```

### Export keys from rbw

```bash
~/bin/export-ssh-keys.sh
```

### Remove a customer's config

Simply rename or delete the JSON file and rebuild:

```bash
mv hosts/customer-a.json hosts/customer-a.json.disabled
home-manager switch
# The rbw-customer-a.conf file will be removed automatically
```

## Architecture

### Why separate config files per JSON?

Each JSON file generates its own SSH config file to:
- **Isolate concerns**: Customer A's config is separate from Customer B
- **Easy management**: Disable/enable entire customer configs by renaming files
- **Clear overview**: `ls ~/.ssh/config.d/rbw-*.conf` shows all active configs
- **Git friendly**: Clear diffs when adding/removing customer configs

### Why rbw SSH agent?

- **No private keys on disk**: All keys stored encrypted in Bitwarden
- **Centralized management**: Manage keys through Bitwarden UI
- **Cross-machine sync**: Keys available on all machines with rbw configured
- **Security**: Keys never leave the SSH agent, even when using them

### Module design

```
JSON files → Nix module → SSH configs
                ↓
          Export script → SSH keys directory
                ↓
          rbw SSH agent → Actual SSH connections
```

## FAQ

**Q: Do I need to restart anything after adding a host?**
A: No, just run `home-manager switch`. SSH reads config files on each connection.

**Q: Can I mix rbw keys with regular SSH keys?**
A: Yes, this module only manages hosts using rbw keys. You can still have regular SSH configs in `~/.ssh/config`.

**Q: What happens if I delete a JSON file?**
A: The corresponding `rbw-*.conf` file is automatically removed on next `home-manager switch`.

**Q: Do I need to run export-ssh-keys.sh every time?**
A: No, only when:
- You add a new SSH key to rbw
- You sync rbw and want to update local key files
- Keys are already in the SSH agent, export is just for config file references

**Q: Can I use wildcards in host patterns?**
A: Yes! Use patterns like `"host": "*.example.com"` or `"host": "192.168.1.*"`.

**Q: How do I backup my configuration?**
A: Just commit the `hosts/*.json` files to Git. Keys are in Bitwarden and backed up there.

**Q: Can I mix regular JSON files with agenix encrypted files?**
A: Yes! The module automatically handles both. Use regular JSON for non-sensitive configs and agenix for production/customer servers.

**Q: What's the difference between normal JSON files and agenix secrets?**
A:
- Normal JSON files: Stored in `hosts/` directory, readable by anyone with Git access
- Agenix secrets: Encrypted `.age` files, only decryptable on authorized machines
- Both generate the same SSH config format, just different security levels

**Q: Do I need to change anything after updating an agenix secret?**
A: Yes, run `sudo nixos-rebuild switch` first to decrypt the new secret, then `home-manager switch` to regenerate the SSH config.

## Examples

See `hosts/customer-a.json.example` for a complete example configuration.

## Related Files

- `export-ssh-keys.sh` - The export script (part of this module)
- `hosts/README.md` - Detailed JSON format documentation
- `../sshkeys.nix` - rbw SSH agent configuration
