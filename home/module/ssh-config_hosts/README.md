# SSH Config Hosts Module

NixOS Home Manager module for managing SSH host configurations with rbw (Bitwarden CLI) SSH keys.

## Features

- ✅ **Automatic discovery**: All `.json` files in `hosts/` directory are automatically loaded
- ✅ **Declarative**: SSH config is generated from JSON files
- ✅ **Multiple files**: Organize configurations by customer, environment, or purpose
- ✅ **rbw integration**: Uses SSH keys from Bitwarden via rbw SSH agent
- ✅ **No private keys on disk**: All keys managed through rbw agent

## Directory Structure

```
home/module/ssh-config_hosts/
├── default.nix              # Main module configuration
├── README.md                # This file
└── hosts/                   # JSON configuration files directory
    ├── README.md            # Documentation for JSON format
    ├── ssh-hosts.json       # General/personal hosts
    ├── customer-a.json      # Customer A hosts
    └── customer-b.json      # Customer B hosts (add as many as needed)
```

## Usage

### 1. Enable the module

In your home configuration:

```nix
imports = [
  ./module/ssh-config_hosts
];
```

### 2. Add SSH hosts

Create a JSON file in `hosts/`:

```bash
vim home/module/ssh-config_hosts/hosts/my-servers.json
```

```json
[
  {
    "host": "myserver",
    "hostname": "192.168.1.100",
    "user": "admin",
    "identity_file": "my-server-key",
    "port": 22
  }
]
```

### 3. Apply configuration

```bash
home-manager switch
```

### 4. Export SSH keys from rbw

```bash
~/bin/export-ssh-keys.sh
```

## How it works

1. **Discovery**: The module scans `hosts/` directory for all `.json` files
2. **Parsing**: Each JSON file is parsed and validated
3. **Generation**: SSH config entries are generated for all hosts
4. **Output**: `~/.ssh/config.d/rbw.conf` is created/updated
5. **Keys**: SSH keys are loaded from `~/.ssh/rbw-keys/` (exported from rbw)

## Generated files

- `~/.ssh/config.d/rbw.conf` - Generated SSH config
- `~/.ssh/rbw-keys/*.pub` - Exported SSH public keys
- `~/bin/export-ssh-keys.sh` - Script to export keys from rbw

## JSON Configuration Format

See `hosts/README.md` for detailed JSON format documentation.

### Quick reference

```json
{
  "host": "alias",              // Required: SSH host alias or pattern
  "hostname": "actual.host",    // Optional: real hostname/IP
  "user": "username",           // Optional: SSH username
  "identity_file": "key-name",  // Required: rbw key name (without .pub)
  "port": 22                    // Optional: SSH port (default: 22)
}
```

## Adding a new customer/project

Simply create a new JSON file:

```bash
vim home/module/ssh-config_hosts/hosts/customer-newco.json
```

No need to modify the Nix configuration - it's automatically discovered!

## SSH Key Management

SSH keys must be:
1. Stored in rbw (Bitwarden) in the `ssh-keys` folder
2. Have a `fingerprint` field (auto-generated by Bitwarden)
3. Loaded into rbw SSH agent

The module provides `~/bin/export-ssh-keys.sh` to export keys from rbw to `~/.ssh/rbw-keys/`.

## Troubleshooting

### Check what files are loaded

The generated config includes a header showing all loaded files:

```bash
head -20 ~/.ssh/config.d/rbw.conf
```

### Verify SSH config

```bash
ssh -G hostname
```

### List available SSH keys

```bash
ssh-add -l
```

### Export keys from rbw

```bash
~/bin/export-ssh-keys.sh
```

## Examples

See `hosts/customer-a.json.example` for a complete example configuration.
